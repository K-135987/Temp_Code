import pandas as pd
import numpy as np
from sklearn.decomposition import PCA
from sklearn.preprocessing import StandardScaler

def split_features(df):
    num_cols = [col for col in df.columns if pd.api.types.is_numeric_dtype(df[col])]
    cat_cols = [col for col in df.columns if not pd.api.types.is_numeric_dtype(df[col])]
    return num_cols, cat_cols

def fit_transform_pca(df_num, n_components=2):
    scaler = StandardScaler()
    X_num = scaler.fit_transform(df_num)
    pca = PCA(n_components=n_components)
    pca_features = pca.fit_transform(X_num)
    return pca_features, scaler, pca

def fit_transform_manual_mca(df_cat, n_components=2):
    # 1. One-hot encode the categorical columns
    Z = pd.get_dummies(df_cat, drop_first=False, dtype=float).values
    n, m = Z.shape

    # 2. Compute row and column sums
    row_sums = Z.sum(axis=1, keepdims=True)
    col_sums = Z.sum(axis=0, keepdims=True)
    total_sum = Z.sum()
    # 3. Compute expected frequencies and residuals
    expected = np.dot(row_sums, col_sums) / total_sum
    residuals = Z - expected

    # 4. Double centering/normalization
    row_sqrt_inv = 1.0 / np.sqrt(row_sums.ravel())
    col_sqrt_inv = 1.0 / np.sqrt(col_sums.ravel())
    D_r_sqrt_inv = np.diag(row_sqrt_inv)
    D_c_sqrt_inv = np.diag(col_sqrt_inv)
    S = D_r_sqrt_inv @ residuals @ D_c_sqrt_inv

    # 5. SVD
    U, s, Vt = np.linalg.svd(S, full_matrices=False)
    # 主成分
    F = D_r_sqrt_inv @ U[:, :n_components] @ np.diag(s[:n_components])

    return F  # (n, n_components)

def combine_features(pca_features, mca_features):
    return np.hstack([pca_features, mca_features])

# ==== 使用範例 ====
if __name__ == "__main__":
    # 建立範例資料
    np.random.seed(42)
    df = pd.DataFrame({
        'age': np.random.randint(20, 60, 100),
        'income': np.random.normal(50000, 10000, 100),
        'gender': np.random.choice(['M', 'F'], 100),
        'city': np.random.choice([f'城市{i}' for i in range(6)], 100)
    })

    num_cols, cat_cols = split_features(df)
    pca_features, scaler, pca_model = fit_transform_pca(df[num_cols], n_components=2)
    mca_features = fit_transform_manual_mca(df[cat_cols], n_components=2)

    mixed_features = combine_features(pca_features, mca_features)
    mixed_features = pd.DataFrame(
        mixed_features,
        columns=[f"PCA_{i+1}" for i in range(pca_features.shape[1])] +
                [f"MCA_{i+1}" for i in range(mca_features.shape[1])]
    )
    print(mixed_features.head())
